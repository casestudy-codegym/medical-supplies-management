<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
</head>
<body>
<div th:fragment="header">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <header class="header">
        <nav class="navbar">
            <div class="navbar-brand">
                <div class="logo">
                    <i class="fas fa-cogs"></i> Hệ thống quản lý
                </div>
            </div>

            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>

            <ul class="nav-menu" id="navMenu">
                <!-- Chỉ hiện khi là ADMIN -->
                <li class="nav-item has-dropdown" sec:authorize="hasRole('ADMIN')">
                    <a href="#" class="nav-link" onclick="toggleDropdown(event, this)">
                        <span><i class="fas fa-tools"></i> Quản lý hệ thống</span>
                    </a>
                    <div class="dropdown">
                        <a th:href="@{/admin/add-employee-account}" class="dropdown-item">
                            <i class="fas fa-user-plus"></i> Thêm tài khoản
                        </a>
                        <a th:href="@{/admin/change-password}" class="dropdown-item">
                            <i class="fas fa-key"></i> Đổi mật khẩu
                        </a>
                        <a th:href="@{/admin/language}" class="dropdown-item">
                            <i class="fas fa-globe"></i> Ngôn ngữ
                        </a>
                    </div>
                </li>

                <!-- Hiện với cả ADMIN và EMPLOYEE -->
                <li class="nav-item has-dropdown" sec:authorize="hasAnyRole('ADMIN', 'ACCOUNTANT', 'SALES')">
                    <a href="#" class="nav-link" onclick="toggleDropdown(event, this)">
                        <span><i class="fas fa-list"></i> Danh mục quản lý</span>
                    </a>
                    <div class="dropdown">
                        <div class="dropdown-submenu">
                            <a href="#" class="dropdown-item" onclick="toggleSubmenu(event, this)">
                                <i class="fas fa-info-circle"></i> Quản lý thông tin
                            </a>
                            <div class="dropdown-sub">
                                <a th:href="@{/management/staff}" class="dropdown-item">
                                    <i class="fas fa-users"></i> Nhân viên
                                </a>
                                <a th:href="@{/management/customers}" class="dropdown-item">
                                    <i class="fas fa-user-friends"></i> Khách hàng
                                </a>
                                <a th:href="@{/management/materials}" class="dropdown-item">
                                    <i class="fas fa-boxes"></i> Vật tư
                                </a>
                            </div>
                        </div>

                        <div class="dropdown-submenu">
                            <a href="#" class="dropdown-item" onclick="toggleSubmenu(event, this)">
                                <i class="fas fa-warehouse"></i> Quản lý kho
                            </a>
                            <div class="dropdown-sub">
                                <a th:href="@{/warehouse/import}" class="dropdown-item">
                                    <i class="fas fa-arrow-down"></i> Nhập kho
                                </a>
                                <div class="dropdown-submenu">
                                    <a href="#" class="dropdown-item" onclick="toggleSubmenu(event, this)">
                                        <i class="fas fa-arrow-up"></i> Xuất kho
                                    </a>
                                    <div class="dropdown-sub">
                                        <a th:href="@{/warehouse/sales}" class="dropdown-item">
                                            <i class="fas fa-shopping-cart"></i> Bán hàng
                                        </a>
                                        <a th:href="@{/warehouse/returns}" class="dropdown-item">
                                            <i class="fas fa-undo"></i> Trả hàng
                                        </a>
                                        <a th:href="@{/warehouse/cancel}" class="dropdown-item">
                                            <i class="fas fa-times"></i> Hủy
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <a th:href="@{/management/salary}" class="dropdown-item">
                            <i class="fas fa-money-bill-wave"></i> Lương
                        </a>
                    </div>
                </li>

                <!-- Thống kê cho tất cả người dùng đã đăng nhập -->
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <a th:href="@{/statistics}" class="nav-link">
                        <span><i class="fas fa-chart-bar"></i> Thống kê</span>
                    </a>
                </li>

                <!-- Thông tin cá nhân cho CUSTOMER -->
                <li class="nav-item" sec:authorize="hasRole('CUSTOMER')">
                    <a th:href="@{/customer/profile}" class="nav-link">
                        <span><i class="fas fa-user-circle"></i> Thông tin cá nhân</span>
                    </a>
                </li>

                <!-- Thông tin cá nhân cho EMPLOYEE hoặc ADMIN -->
                <li class="nav-item" sec:authorize="hasAnyRole('ACCOUNTANT','SALES','ADMIN')">
                    <a th:href="@{/employee/profile}" class="nav-link">
                        <span><i class="fas fa-user-circle"></i> Thông tin cá nhân</span>
                    </a>
                </li>

                <!-- Trợ giúp cho tất cả -->
                <li class="nav-item">
                    <a th:href="@{/help}" class="nav-link">
                        <span><i class="fas fa-question-circle"></i> Trợ giúp</span>
                    </a>
                </li>

                <!-- User (mobile) -->
                <li class="nav-item mobile-user-info">
                    <div class="user-info" sec:authorize="isAuthenticated()">
                        <div class="user-avatar"><i class="fas fa-user"></i></div>
                        <span sec:authentication="name">User</span>
                    </div>
                    <div class="login-button" sec:authorize="!isAuthenticated()">
                        <a th:href="@{/auth/login}" class="btn-login">
                            <i class="fas fa-sign-in-alt"></i> Đăng nhập
                        </a>
                    </div>
                </li>
            </ul>

            <!-- User (desktop) -->
            <div class="user-info desktop-user-info" sec:authorize="isAuthenticated()">
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <span sec:authentication="name">User</span>
                <a th:href="@{/auth/logout}" class="logout-link">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            <div class="login-button desktop-login" sec:authorize="!isAuthenticated()">
                <a th:href="@{/auth/login}" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                </a>
            </div>
        </nav>
        <div class="d-flex align-items-center">
            <!-- Các menu khác của bạn -->
            <a th:href="@{/cart}" class="position-relative ms-4">
                <i class="fas fa-shopping-cart fa-2x"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                      th:text="${cartCount != null ? cartCount : 0}">0</span>
            </a>
        </div>

    </header>

    <script>
        function toggleMobileMenu() {
            const navMenu = document.getElementById('navMenu');
            const toggleBtn = document.querySelector('.mobile-menu-toggle i');
            navMenu.classList.toggle('active');
            toggleBtn.className = navMenu.classList.contains('active') ? 'fas fa-times' : 'fas fa-bars';
            if (!navMenu.classList.contains('active')) {
                document.querySelectorAll('.nav-item, .dropdown-submenu').forEach(el => el.classList.remove('active'));
            }
        }

        function toggleDropdown(event, element) {
            event.preventDefault();
            const navItem = element.closest('.nav-item');
            if (window.innerWidth <= 768) {
                const isActive = navItem.classList.contains('active');
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                if (!isActive) navItem.classList.add('active');
            } else {
                const dropdown = navItem.querySelector('.dropdown');
                const isVisible = dropdown.style.opacity === '1';
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.style.opacity = '0';
                    d.style.visibility = 'hidden';
                    d.style.transform = 'translateY(-10px)';
                });
                if (!isVisible) {
                    dropdown.style.opacity = '1';
                    dropdown.style.visibility = 'visible';
                    dropdown.style.transform = 'translateY(0)';
                }
            }
        }

        function toggleSubmenu(event, element) {
            event.preventDefault();
            event.stopPropagation();
            const submenu = element.closest('.dropdown-submenu');
            if (window.innerWidth <= 768) {
                submenu.classList.toggle('active');
            } else {
                const dropdown = submenu.querySelector('.dropdown-sub');
                dropdown.style.opacity = '1';
                dropdown.style.visibility = 'visible';
                dropdown.style.transform = 'translateX(0)';
            }
        }

        document.addEventListener('click', function (event) {
            if (window.innerWidth > 768) {
                let clickedOutside = true;
                document.querySelectorAll('.nav-item.has-dropdown').forEach(item => {
                    if (item.contains(event.target)) clickedOutside = false;
                });
                if (clickedOutside) {
                    document.querySelectorAll('.dropdown').forEach(d => {
                        d.style.opacity = '0';
                        d.style.visibility = 'hidden';
                        d.style.transform = 'translateY(-10px)';
                    });
                }
            }
        });

        window.addEventListener('resize', function () {
            const navMenu = document.getElementById('navMenu');
            const toggleBtn = document.querySelector('.mobile-menu-toggle i');
            if (window.innerWidth > 768) {
                navMenu.classList.remove('active');
                toggleBtn.className = 'fas fa-bars';
                document.querySelectorAll('.nav-item, .dropdown-submenu').forEach(el => el.classList.remove('active'));
            }
            updateUserInfoVisibility();
        });

        function updateUserInfoVisibility() {
            const mobileUserInfo = document.querySelector('.mobile-user-info');
            const desktopUserInfo = document.querySelector('.desktop-user-info');
            if (window.innerWidth <= 768) {
                if (mobileUserInfo) mobileUserInfo.style.display = 'block';
                if (desktopUserInfo) desktopUserInfo.style.display = 'none';
            } else {
                if (mobileUserInfo) mobileUserInfo.style.display = 'none';
                if (desktopUserInfo) desktopUserInfo.style.display = 'flex';
            }
        }

        updateUserInfoVisibility();
    </script>
</div>
</body>
</html>
