<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh sửa thông tin cá nhân</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.png">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f2f2f2;
            color: #293a58;
        }

        .cus-container {
            max-width: 1040px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            padding: 40px 48px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
        }

        .cus-title {
            text-align: center;
            margin-bottom: 26px;
            font-weight: 700;
            color: #293a58;
        }

        .form-layout {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 28px 32px;
            align-items: start;
        }

        .cus-avatar-wrapper {
            position: relative;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #293a58;
            cursor: pointer;
        }

        .cus-avatar-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* overlay chữ Change Avatar */
        .cus-avatar-wrapper .avatar-overlay {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.55);
            color: #fff;
            text-align: center;
            font-size: 14px;
            padding: 6px 0;
            opacity: 0;
            transition: opacity .25s ease;
            pointer-events: none;
        }

        .cus-avatar-wrapper:hover .avatar-overlay {
            opacity: 1;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px 18px;
        }

        .form-item {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 700;
            margin-bottom: 6px;
            color: #293a58;
        }

        .cus-container input[type="text"],
        .cus-container input[type="email"],
        .cus-container select {
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
            padding: 10px;
        }

        .cus-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 28px;
        }

        .cus-actions .btn-primary {
            background-color: #293a58;
            border: none;
            padding: 10px 28px;
            font-size: 16px;
        }

        .cus-actions .btn-primary:hover {
            background-color: #1c2940;
        }

        .cus-actions .btn-secondary {
            background-color: #6c757d;
            border: none;
            padding: 10px 28px;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .form-layout {
                grid-template-columns: 1fr;
                justify-items: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
<div sec:authorize="hasRole('CUSTOMER')" th:replace="~{layout/userHeader :: header}"></div>
<div sec:authorize="!hasRole('CUSTOMER')" th:replace="~{layout/header :: header}"></div>

<div class="cus-container" th:if="${customer != null}">
    <h2 class="cus-title">Chỉnh sửa thông tin cá nhân</h2>

    <form th:action="@{/customer/edit}" th:object="${customer}" method="post">
        <div class="form-layout">
            <!-- Avatar -->
            <div class="text-center">
                <div class="cus-avatar-wrapper" onclick="document.getElementById('avatarFileInput').click()">
                    <img id="avatarPreview" th:src="${customer.avatarUrl}" alt="Avatar">
                    <div class="avatar-overlay"><i class="fa-solid fa-camera me-1"></i> Change Avatar</div>
                </div>
                <input type="file" id="avatarFileInput" accept="image/*" style="display:none;">
                <input type="hidden" id="avatarUrlInput" th:field="*{avatarUrl}">
            </div>

            <!-- Form -->
            <div>
                <div class="form-grid">
                    <div class="form-item">
                        <label>Tên đăng nhập:</label>
                        <input type="text" th:field="*{username}" readonly>
                    </div>
                    <div class="form-item">
                        <label>Họ tên:</label>
                        <input type="text" th:field="*{name}" required>
                    </div>
                    <div class="form-item">
                        <label>Mã khách hàng:</label>
                        <input type="text" th:field="*{customerCode}" readonly>
                    </div>
                    <div class="form-item">
                        <label>Số điện thoại:</label>
                        <input type="text" th:field="*{phone}">
                    </div>
                    <div class="form-item">
                        <label>Email:</label>
                        <input type="email" th:field="*{email}">
                    </div>
                    <div class="form-item">
                        <label>Địa chỉ:</label>
                        <input type="text" th:field="*{address}">
                    </div>
                    <div class="form-item">
                        <label>Loại khách hàng:</label>
                        <select th:field="*{type}">
                            <option value="RETAIL">RETAIL</option>
                            <option value="WHOLESALE">WHOLESALE</option>
                            <option value="SUPPLIER">SUPPLIER</option>
                        </select>
                    </div>
                </div>

                <div class="cus-actions">
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                    <a th:href="@{/customer/profile}" class="btn btn-secondary">Trở về</a>
                </div>
            </div>
        </div>
    </form>
</div>

<div th:replace="layout/footer :: footer"></div>

<script>
    const avatarInput = document.getElementById('avatarFileInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarUrlInput = document.getElementById('avatarUrlInput');

    if (avatarInput) {
        avatarInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => avatarPreview.src = e.target.result;
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'medical_supplies_management');

            fetch('https://api.cloudinary.com/v1_1/dkxc1x4ic/image/upload', {
                method: 'POST',
                body: formData
            })
                .then(r => r.json())
                .then(data => avatarUrlInput.value = data.secure_url)
                .catch(err => console.error('Upload avatar error:', err));
        });
    }
</script>
</body>
</html>